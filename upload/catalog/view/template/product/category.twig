{{ header }}
<div id="product-category" class="container my-4 my-lg-5">
  {# Breadcrumb Navigation #}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-light px-3 py-2 rounded shadow-sm">
      {% for breadcrumb in breadcrumbs %}
        <li class="breadcrumb-item{% if loop.last %} active{% endif %}">
          {% if not loop.last %}
            <a href="{{ breadcrumb.href }}" class="text-decoration-none">{{ breadcrumb.text }}</a>
          {% else %}
            {{ breadcrumb.text }}
          {% endif %}
        </li>
      {% endfor %}
    </ol>
  </nav>

  <div class="row g-4">
    {% if column_left %}
    <div class="col-12 col-lg-3">
      <div class="sticky-top-100">
        {{ column_left }}
      </div>
    </div>
    {% endif %}
    <div id="content" class="col-12{% if column_left %} col-lg-9{% endif %}">
      {{ content_top }}

      {# Category Header #}
      <div class="mb-4">
        <h1 class="mb-3">{{ heading_title }}</h1>
        {% if image or description %}
          <div class="card border-0 shadow-sm bg-light">
            <div class="card-body">
              <div class="row g-4">
                {% if image %}
                  <div class="col-md-3 text-center">
                    <img src="{{ image }}" alt="{{ heading_title }}" title="{{ heading_title }}" class="img-fluid rounded shadow-sm"/>
                  </div>
                {% endif %}
                {% if description %}
                  <div class="col-md-9">
                    {{ description }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      {# Subcategories #}
      {% if categories %}
        <div class="mb-4">
          <h5 class="mb-3">{{ text_refine }}</h5>
          {% if categories|length <= 5 %}
            <ul class="list-unstyled">
              {% for category in categories %}
                <li class="mb-2">
                  <a href="{{ category.href }}" class="text-decoration-none">
                    <i class="fa-solid fa-chevron-right fa-xs me-2"></i>{{ category.name }}
                  </a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3 g-lg-4">
              {% set total = categories|length %}
              {% if total > 20 %}
                {% set batch = (total / 5)|round(0, 'ceil') %}
              {% else %}
                {% set batch = 5 %}
              {% endif %}
              {% for category_batch in categories|batch(batch) %}
                <div class="col">
                  <ul class="list-unstyled">
                    {% for category in category_batch %}
                      <li class="mb-2">
                        <a href="{{ category.href }}" class="text-decoration-none d-flex align-items-center">
                          <i class="fa-solid fa-chevron-right fa-xs me-2 text-muted"></i>
                          <span class="text-truncate">{{ category.name }}</span>
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# Products Section #}
      {% if products %}
        {# Toolbar #}
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <div class="row g-3 align-items-center">
              <div class="col-lg-3 col-md-4">
                <a href="{{ compare }}" id="compare-total" class="btn btn-outline-primary w-100">
                  <i class="fa-solid fa-arrow-right-arrow-left"></i>
                  <span class="d-none d-lg-inline ms-2">{{ text_compare }}</span>
                </a>
              </div>
              <div class="col-auto d-none d-lg-block">
                <div class="btn-group shadow-sm" role="group">
                  <button type="button" id="button-list" class="btn btn-outline-secondary" data-bs-toggle="tooltip" title="{{ button_list }}">
                    <i class="fa-solid fa-table-list"></i>
                  </button>
                  <button type="button" id="button-grid" class="btn btn-outline-secondary" data-bs-toggle="tooltip" title="{{ button_grid }}">
                    <i class="fa-solid fa-table-cells"></i>
                  </button>
                </div>
              </div>
              <div class="col-lg-4 col-md-4 col-6">
                <div class="input-group shadow-sm">
                  <label for="input-sort" class="input-group-text">
                    <i class="fa-solid fa-sort me-2 d-none d-lg-inline"></i>{{ text_sort }}
                  </label>
                  <select id="input-sort" class="form-select" onchange="location = this.value;">
                    {% for sorts in sorts %}
                      <option value="{{ sorts.href }}"{% if sorts.value == '%s-%s'|format(sort, order) %} selected{% endif %}>
                        {{ sorts.text }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-lg-3 col-md-4 col-6">
                <div class="input-group shadow-sm">
                  <label for="input-limit" class="input-group-text">
                    <i class="fa-solid fa-list-ol me-2 d-none d-lg-inline"></i>{{ text_limit }}
                  </label>
                  <select id="input-limit" class="form-select" onchange="location = this.value;">
                    {% for limits in limits %}
                      <option value="{{ limits.href }}"{% if limits.value == limit %} selected{% endif %}>
                        {{ limits.text }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# Product Grid with Modern Bootstrap Patterns #}
        <div id="product-list" class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3 g-lg-4 mb-4">
          {% for product in products %}
            <div class="col fade-in">
              <div class="h-100">{{ product }}</div>
            </div>
          {% endfor %}
        </div>

        {# Loading Placeholders (hidden by default, shown via JS) #}
        <div id="product-list-loading" class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3 g-lg-4 mb-4 d-none" aria-hidden="true">
          {% for i in 1..12 %}
            <div class="col">
              <div class="product-card-skeleton">
                <div class="card h-100">
                  <div class="card-img-top placeholder-glow">
                    <div class="placeholder col-12 rounded-top" style="height: 200px;"></div>
                  </div>
                  <div class="card-body">
                    <h5 class="card-title placeholder-glow">
                      <span class="placeholder col-8"></span>
                    </h5>
                    <div class="placeholder-glow mb-2">
                      <span class="placeholder col-6"></span>
                      <span class="placeholder col-4"></span>
                    </div>
                    <p class="card-text placeholder-glow">
                      <span class="placeholder col-7"></span>
                      <span class="placeholder col-4"></span>
                      <span class="placeholder col-6"></span>
                    </p>
                    <div class="d-flex justify-content-between align-items-center placeholder-glow">
                      <div class="product-price-skeleton col-3"></div>
                      <span class="placeholder col-4 bg-primary" style="height: 38px; border-radius: 0.375rem;"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        {# Pagination #}
        <div class="row">
          <div class="col-sm-6 text-start">{{ pagination }}</div>
          <div class="col-sm-6 text-end text-body-secondary">{{ results }}</div>
        </div>
      {% endif %}

      {# Empty State #}
      {% if not categories and not products %}
        <div class="text-center py-5">
          <i class="fa-solid fa-box-open fa-3x mb-3 text-body-secondary opacity-25"></i>
          <p class="text-body-secondary mb-4">{{ text_no_results }}</p>
          <a href="{{ continue }}" class="btn btn-primary shadow-sm">
            <i class="fa-solid fa-arrow-left me-2"></i>{{ button_continue }}
          </a>
        </div>
      {% endif %}
      {{ content_bottom }}
    </div>
    {% if column_right %}
    <div class="col-12 col-lg-3">
      <div class="sticky-top-100">
        {{ column_right }}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
$(document).ready(function() {
    'use strict';

    // Показать loading состояние при изменении сортировки и лимита
    $('#input-sort, #input-limit').on('change', function() {
        showProductsLoading();
    });

    // Обработчик для переключения видов списка/сетки
    $('#button-list, #button-grid').on('click', function(e) {
        e.preventDefault();
        showProductsLoading();
        
        // Имитируем переключение (в реальном проекте здесь будет AJAX)
        setTimeout(function() {
            hideProductsLoading();
        }, 800);
    });

    // Обработчик для кнопки сравнения
    $('#compare-total').on('click', function(e) {
        e.preventDefault();
        const $btn = $(this);
        
        loadingManager.showSpinner($btn, 'sm', 'primary', 'Загрузка...');
        
        // Имитируем загрузку сравнения
        setTimeout(function() {
            loadingManager.hide($btn);
            // В реальном проекте здесь будет переход на страницу сравнения
            window.location.href = $btn.attr('href');
        }, 1000);
    });

    /**
     * Показать loading состояние для продуктов
     */
    function showProductsLoading() {
        $('#product-list').fadeOut(200, function() {
            $('#product-list-loading').removeClass('d-none').hide().fadeIn(300);
        });
    }

    /**
     * Скрыть loading состояние для продуктов
     */
    function hideProductsLoading() {
        $('#product-list-loading').fadeOut(200, function() {
            $(this).addClass('d-none');
            $('#product-list').fadeIn(300);
        });
    }

    // Обработчик для AJAX фильтрации (если используется)
    $(document).on('change', '.filter-checkbox, .filter-radio', function() {
        const $container = $('#product-list');
        
        loadingManager.ajax({
            url: '{{ filter_url|default("index.php?route=product/category&category_id=" ~ category_id) }}',
            type: 'GET',
            data: $(this).closest('form').serialize(),
            success: function(data) {
                // Обновляем контент
                if (data.products) {
                    $container.html(data.products);
                }
                if (data.pagination) {
                    $('.pagination').html(data.pagination);
                }
            },
            error: function() {
                console.error('Ошибка при загрузке продуктов');
            }
        }, {
            container: $container,
            placeholderType: 'product',
            placeholderCount: 12,
            loadingText: 'Фильтрация...'
        });
    });

    // Инициализация tooltips для кнопок управления видом
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Плавная анимация появления продуктов
    $('.fade-in').each(function(index) {
        $(this).css('animation-delay', (index * 0.1) + 's');
    });
});
</script>

<style>
/* Дополнительные стили для плавного появления */
.fade-in {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 0.6s ease forwards;
}

@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Улучшенные стили для toolbar */
.card-body .btn-group {
    border-radius: 0.375rem;
    overflow: hidden;
}

.card-body .btn-group .btn {
    border-radius: 0;
}

.card-body .btn-group .btn:first-child {
    border-radius: 0.375rem 0 0 0.375rem;
}

.card-body .btn-group .btn:last-child {
    border-radius: 0 0.375rem 0.375rem 0;
}

/* Стилизация для мобильных устройств */
@media (max-width: 768px) {
    .fade-in {
        animation-delay: 0s !important;
    }
    
    .product-card-skeleton .card-body {
        padding: 0.75rem;
    }
    
    .placeholder {
        border-radius: 0.25rem;
    }
}
</style>

{{ footer }}
