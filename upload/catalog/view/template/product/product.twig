{{ header }}
<div id="product-info" class="container py-4">
  {# Breadcrumb Navigation #}
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      {% for breadcrumb in breadcrumbs %}
        <li class="breadcrumb-item{% if loop.last %} active{% endif %}">
          {% if loop.last %}
            {{ breadcrumb.text }}
          {% else %}
            <a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a>
          {% endif %}
        </li>
      {% endfor %}
    </ol>
  </nav>

  <div class="row">
    {{ column_left }}

    <div id="content" class="col">
      {{ content_top }}

      <div class="product-detail-wrapper">
        <div class="row g-4">
          {# Product Images Gallery #}
          {% if thumb or images %}
            <div class="col-lg-6">
              <div class="product-gallery position-sticky" style="top: 20px;">
                {# Main Image #}
                <div class="main-image-wrapper mb-3">
                  {% if thumb %}
                    <div class="image-magnifier border rounded overflow-hidden bg-light" style="height: 500px;">
                      <a href="{{ popup }}" title="{{ heading_title }}" class="d-block h-100">
                        <img src="{{ thumb }}" title="{{ heading_title }}" alt="{{ heading_title }}" class="img-fluid w-100 h-100" style="object-fit: contain;" id="main-product-image"/>
                      </a>
                    </div>
                  {% endif %}
                </div>

                {# Thumbnail Gallery #}
                {% if images %}
                  <div class="thumbnail-gallery">
                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                      {% if thumb %}
                        <div class="thumbnail-item active border rounded overflow-hidden" data-image="{{ thumb }}" data-popup="{{ popup }}" style="width: 80px; height: 80px; cursor: pointer;">
                          <img src="{{ thumb }}" alt="{{ heading_title }}" class="img-fluid w-100 h-100" style="object-fit: cover;"/>
                        </div>
                      {% endif %}
                      {% for image in images %}
                        <div class="thumbnail-item border rounded overflow-hidden" data-image="{{ image.thumb }}" data-popup="{{ image.popup }}" style="width: 80px; height: 80px; cursor: pointer;">
                          <img src="{{ image.thumb }}" alt="{{ heading_title }}" class="img-fluid w-100 h-100" style="object-fit: cover;"/>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}

          {# Product Details #}
          <div class="col-lg-6">
            <div class="product-info">
              {# Product Title #}
              <h1 class="product-title display-6 fw-bold mb-3">{{ heading_title }}</h1>

              {# Product Meta Information #}
              <div class="product-meta mb-4">
                <ul class="list-unstyled">
                  {% if manufacturer %}
                    <li class="mb-2">
                      <span class="text-muted">{{ text_manufacturer }}:</span>
                      <strong><a href="{{ manufacturers }}" class="text-decoration-none">{{ manufacturer }}</a></strong>
                    </li>
                  {% endif %}
                  <li class="mb-2">
                    <span class="text-muted">{{ text_model }}:</span>
                    <strong>{{ model }}</strong>
                  </li>
                  {% for product_code in product_codes %}
                    <li class="mb-2">
                      <span class="text-muted">{{ product_code.code }}:</span>
                      <strong>{{ product_code.value }}</strong>
                    </li>
                  {% endfor %}
                  <li class="mb-2">
                    <span class="text-muted">{{ text_stock }}:</span>
                    <strong><span class="badge bg-{% if stock %}success{% else %}danger{% endif %}">{{ stock_status }}</span></strong>
                  </li>
                  {% if reward %}
                    <li class="mb-2">
                      <span class="text-muted">{{ text_reward }}:</span>
                      <strong class="text-success">{{ reward }}</strong>
                    </li>
                  {% endif %}
                </ul>
              </div>

              {# Rating Stars #}
              {% if review_status %}
                <div class="product-rating d-flex align-items-center mb-4 p-3 bg-light rounded">
                  <div class="stars text-warning fs-5 me-3">
                    {% for i in 1..5 %}
                      {% if rating >= i %}
                        <i class="bi bi-star-fill"></i>
                      {% elseif rating >= (i - 0.5) %}
                        <i class="bi bi-star-half"></i>
                      {% else %}
                        <i class="bi bi-star"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <span class="text-muted">({{ rating }} / 5)</span>
                </div>
              {% endif %}

              {# Price Section #}
              {% if price %}
                <div class="product-price mb-4 p-4 bg-light rounded">
                  {% if not special %}
                    <div class="price-current">
                      <span class="h2 text-dark fw-bold mb-0">
                        <x-currency code="{{ currency }}" amount="{{ price }}"></x-currency>
                      </span>
                    </div>
                  {% else %}
                    <div class="price-special">
                      <span class="price-old text-muted text-decoration-line-through h5 d-block mb-2">
                        <x-currency code="{{ currency }}" amount="{{ price }}"></x-currency>
                      </span>
                      <span class="price-new h2 text-danger fw-bold">
                        <x-currency code="{{ currency }}" amount="{{ special }}"></x-currency>
                      </span>
                      <span class="badge bg-danger ms-2">Sale</span>
                    </div>
                  {% endif %}
                  {% if tax %}
                    <p class="price-tax text-muted small mb-0 mt-2">
                      {{ text_tax }} <x-currency code="{{ currency }}" amount="{{ tax }}"></x-currency>
                    </p>
                  {% endif %}
                  {% if points %}
                    <p class="price-points text-success small mb-0">
                      <i class="bi bi-award"></i> {{ text_points }} {{ points }}
                    </p>
                  {% endif %}
                  {% if discounts %}
                    <hr class="my-3">
                    <div class="bulk-discounts">
                      <h6 class="small text-uppercase fw-bold mb-2">Bulk Discounts</h6>
                      {% for discount in discounts %}
                        <div class="d-flex justify-content-between small text-muted">
                          <span>{{ discount.quantity }}{{ text_discount }}</span>
                          <strong><x-currency code="{{ currency }}" amount="{{ discount.price }}"></x-currency></strong>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endif %}

              {# Quick Actions (Wishlist & Compare) #}
              <div class="quick-actions mb-4">
                <form method="post" data-oc-toggle="ajax">
                  <div class="btn-group w-100" role="group">
                    <button type="submit" formaction="{{ wishlist_add }}" data-bs-toggle="tooltip" class="btn btn-outline-danger" title="{{ button_wishlist }}">
                      <i class="bi bi-heart"></i> Wishlist
                    </button>
                    <button type="submit" formaction="{{ compare_add }}" data-bs-toggle="tooltip" class="btn btn-outline-primary" title="{{ button_compare }}">
                      <i class="bi bi-arrow-left-right"></i> Compare
                    </button>
                  </div>
                  <input type="hidden" name="product_id" value="{{ product_id }}"/>
                </form>
              </div>

              {# Product Options Form #}
              <div id="product" class="product-options-form">
                <form id="form-product">
                  {% if options %}
                    <hr class="my-4">
                    <h3 class="h5 text-uppercase fw-bold mb-3">{{ text_option }}</h3>
                    <div class="options-wrapper">
                      {% for option in options %}

                        {% if option.type == 'select' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label for="input-option-{{ option.product_option_id }}" class="form-label fw-semibold">{{ option.name }}</label>
                            <select name="option[{{ option.product_option_id }}]" id="input-option-{{ option.product_option_id }}" class="form-select">
                              <option value="">{{ text_select }}</option>
                              {% for option_value in option.product_option_value %}
                                <option value="{{ option_value.product_option_value_id }}">{{ option_value.name }}
                                  {% if option_value.price %}
                                    ({{ option_value.price_prefix }}<x-currency code="{{ currency }}" amount="{{ option_value.price }}"></x-currency>)
                                  {% endif %}
                                </option>
                              {% endfor %}
                            </select>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}

                        {% if option.type == 'radio' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label class="form-label fw-semibold">{{ option.name }}</label>
                            <div id="input-option-{{ option.product_option_id }}" class="d-flex flex-wrap gap-2">
                              {% for option_value in option.product_option_value %}
                                <div class="form-check">
                                  <input type="radio" name="option[{{ option.product_option_id }}]" value="{{ option_value.product_option_value_id }}" id="input-option-value-{{ option_value.product_option_value_id }}" class="form-check-input"/>
                                  <label for="input-option-value-{{ option_value.product_option_value_id }}" class="form-check-label">
                                    {% if option_value.image %}
                                      <img src="{{ option_value.image }}" alt="{{ option_value.name }}" class="img-thumbnail" style="width: 50px;"/>
                                    {% endif %}
                                    {{ option_value.name }}
                                    {% if option_value.price %}
                                      <small>({{ option_value.price_prefix }}<x-currency code="{{ currency }}" amount="{{ option_value.price }}"></x-currency>)</small>
                                    {% endif %}
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}

                        {% if option.type == 'checkbox' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label class="form-label fw-semibold">{{ option.name }}</label>
                            <div id="input-option-{{ option.product_option_id }}" class="d-flex flex-wrap gap-2">
                              {% for option_value in option.product_option_value %}
                                <div class="form-check">
                                  <input type="checkbox" name="option[{{ option.product_option_id }}][]" value="{{ option_value.product_option_value_id }}" id="input-option-value-{{ option_value.product_option_value_id }}" class="form-check-input"/>
                                  <label for="input-option-value-{{ option_value.product_option_value_id }}" class="form-check-label">
                                    {% if option_value.image %}
                                      <img src="{{ option_value.image }}" alt="{{ option_value.name }}" class="img-thumbnail" style="width: 50px;"/>
                                    {% endif %}
                                    {{ option_value.name }}
                                    {% if option_value.price %}
                                      <small>({{ option_value.price_prefix }}<x-currency code="{{ currency }}" amount="{{ option_value.price }}"></x-currency>)</small>
                                    {% endif %}
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}

                        {% if option.type == 'text' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label for="input-option-{{ option.product_option_id }}" class="form-label fw-semibold">{{ option.name }}</label>
                            <input type="text" name="option[{{ option.product_option_id }}]" value="{{ option.value }}" placeholder="{{ option.name }}" id="input-option-{{ option.product_option_id }}" class="form-control"/>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}

                        {% if option.type == 'textarea' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label for="input-option-{{ option.product_option_id }}" class="form-label fw-semibold">{{ option.name }}</label>
                            <textarea name="option[{{ option.product_option_id }}]" rows="5" placeholder="{{ option.name }}" id="input-option-{{ option.product_option_id }}" class="form-control">{{ option.value }}</textarea>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}

                        {% if option.type == 'file' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label for="button-upload-{{ option.product_option_id }}" class="form-label fw-semibold">{{ option.name }}</label>
                            <div>
                              <button type="button" id="button-upload-{{ option.product_option_id }}" data-oc-toggle="upload" data-oc-url="{{ upload }}" data-oc-target="#input-option-{{ option.product_option_id }}" data-oc-size-max="{{ config_file_max_size }}" data-oc-size-error="{{ error_upload_size }}" class="btn btn-outline-primary btn-block">
                                <i class="bi bi-upload"></i> {{ button_upload }}
                              </button>
                              <input type="hidden" name="option[{{ option.product_option_id }}]" value="" id="input-option-{{ option.product_option_id }}"/>
                            </div>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}

                        {% if option.type == 'date' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label for="input-option-{{ option.product_option_id }}" class="form-label fw-semibold">{{ option.name }}</label>
                            <input type="date" name="option[{{ option.product_option_id }}]" value="{{ option.value }}" id="input-option-{{ option.product_option_id }}" class="form-control"/>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}

                        {% if option.type == 'time' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label for="input-option-{{ option.product_option_id }}" class="form-label fw-semibold">{{ option.name }}</label>
                            <input type="time" name="option[{{ option.product_option_id }}]" value="{{ option.value }}" id="input-option-{{ option.product_option_id }}" class="form-control"/>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}

                        {% if option.type == 'datetime' %}
                          <div class="mb-3{% if option.required %} required{% endif %}">
                            <label for="input-option-{{ option.product_option_id }}" class="form-label fw-semibold">{{ option.name }}</label>
                            <input type="datetime-local" name="option[{{ option.product_option_id }}]" value="{{ option.value }}" id="input-option-{{ option.product_option_id }}" class="form-control"/>
                            <div id="error-option-{{ option.product_option_id }}" class="invalid-feedback"></div>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}

                  {% if subscription_plans %}
                    <hr class="my-4"/>
                    <h3 class="h5 text-uppercase fw-bold mb-3">{{ text_subscription }}</h3>
                    <div class="mb-3">
                      <select name="subscription_plan_id" id="input-subscription" class="form-select" required>
                        <option value="">{{ text_select }}</option>
                        {% for subscription_plan in subscription_plans %}
                          <option value="{{ subscription_plan.subscription_plan_id }}">{{ subscription_plan.name }}</option>
                        {% endfor %}
                      </select>
                      {% for subscription_plan in subscription_plans %}
                        <div id="subscription-description-{{ subscription_plan.subscription_plan_id }}" class="form-text subscription d-none">{{ subscription_plan.description }}</div>
                      {% endfor %}
                      <div id="error-subscription" class="invalid-feedback"></div>
                    </div>
                  {% endif %}

                  {# Quantity and Add to Cart #}
                  <div class="add-to-cart-section mt-4">
                    <div class="row g-3">
                      <div class="col-md-4">
                        <label for="input-quantity" class="form-label fw-semibold">{{ entry_qty }}</label>
                        <input type="number" name="quantity" value="{{ minimum }}" min="{{ minimum }}" id="input-quantity" class="form-control form-control-lg text-center"/>
                        <div id="error-quantity" class="form-text"></div>
                      </div>
                      <div class="col-md-8 d-flex align-items-end">
                        <button type="submit" id="button-cart" class="btn btn-primary btn-lg w-100">
                          <i class="bi bi-cart-plus"></i> {{ button_cart }}
                        </button>
                      </div>
                    </div>
                    <input type="hidden" name="product_id" value="{{ product_id }}" id="input-product-id"/>
                  </div>

                  {% if minimum > 1 %}
                    <div class="alert alert-warning mt-3">
                      <i class="bi bi-info-circle"></i> {{ text_minimum }}
                    </div>
                  {% endif %}
                </form>
              </div>
            </div>
          </div>
        </div>

        {# Product Tabs Section #}
        <div class="product-tabs mt-5">
          <ul class="nav nav-tabs nav-fill" role="tablist">
            <li class="nav-item">
              <a href="#tab-description" data-bs-toggle="tab" class="nav-link active">
                <i class="bi bi-file-text"></i> {{ tab_description }}
              </a>
            </li>
            {% if attribute_groups %}
              <li class="nav-item">
                <a href="#tab-specification" data-bs-toggle="tab" class="nav-link">
                  <i class="bi bi-list-check"></i> {{ tab_attribute }}
                </a>
              </li>
            {% endif %}
            {% if review_status %}
              <li class="nav-item">
                <a href="#tab-review" data-bs-toggle="tab" class="nav-link">
                  <i class="bi bi-chat-left-text"></i> {{ tab_review }}
                </a>
              </li>
            {% endif %}
          </ul>

          <div class="tab-content bg-light p-4 rounded-bottom">
            <div id="tab-description" class="tab-pane fade show active">
              <div class="product-description">
                {{ description }}
              </div>
              {% if tags %}
                <div class="product-tags mt-4">
                  <h6 class="fw-bold">{{ text_tags }}</h6>
                  <div class="d-flex flex-wrap gap-2">
                    {% for tag in tags %}
                      <a href="{{ tag.href }}" class="badge bg-secondary text-decoration-none">{{ tag.tag }}</a>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>

            {% if attribute_groups %}
              <div id="tab-specification" class="tab-pane fade">
                <div class="table-responsive">
                  <table class="table table-bordered table-striped">
                    {% for attribute_group in attribute_groups %}
                      <thead class="table-dark">
                        <tr>
                          <th colspan="2">{{ attribute_group.name }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for attribute in attribute_group.attribute %}
                          <tr>
                            <td class="fw-semibold" style="width: 30%;">{{ attribute.name }}</td>
                            <td>{{ attribute.text }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    {% endfor %}
                  </table>
                </div>
              </div>
            {% endif %}

            {% if review_status %}
              <div id="tab-review" class="tab-pane fade">{{ review }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      {# Related Products #}
      {{ related }}

      {{ content_bottom }}
    </div>

    {{ column_right }}
  </div>
</div>

<style>
/* Product Gallery Styles */
.product-gallery .main-image-wrapper {
  position: relative;
}

.thumbnail-item {
  transition: all 0.3s ease;
  opacity: 0.6;
}

.thumbnail-item:hover,
.thumbnail-item.active {
  opacity: 1;
  border-color: var(--bs-primary) !important;
  border-width: 2px !important;
}

/* Product Info Styles */
.product-title {
  line-height: 1.3;
}

.product-meta ul li {
  padding: 0.5rem 0;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.product-meta ul li:last-child {
  border-bottom: none;
}

/* Price Section */
.product-price {
  border: 2px solid rgba(0,0,0,0.1);
}

/* Options Styling */
.options-wrapper .form-check {
  padding: 0.75rem;
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 0.375rem;
  transition: all 0.3s ease;
}

.options-wrapper .form-check:hover {
  border-color: var(--bs-primary);
  background-color: rgba(var(--bs-primary-rgb), 0.05);
}

.options-wrapper .form-check-input:checked + .form-check-label {
  color: var(--bs-primary);
  font-weight: 600;
}

/* Add to Cart Section */
.add-to-cart-section {
  border-top: 2px solid rgba(0,0,0,0.1);
  padding-top: 1.5rem;
}

/* Product Tabs */
.product-tabs .nav-tabs {
  border-bottom: 2px solid var(--bs-primary);
}

.product-tabs .nav-link {
  font-weight: 600;
  color: #6c757d;
  transition: all 0.3s ease;
}

.product-tabs .nav-link:hover {
  color: var(--bs-primary);
}

.product-tabs .nav-link.active {
  color: var(--bs-primary);
  background-color: var(--bs-light);
}

/* Responsive Adjustments */
@media (max-width: 991px) {
  .product-gallery {
    position: static !important;
  }

  .main-image-wrapper {
    height: auto !important;
  }
}
</style>

<script type="text/javascript">
// Thumbnail Gallery Navigation
document.addEventListener('DOMContentLoaded', function() {
  const thumbnails = document.querySelectorAll('.thumbnail-item');
  const mainImage = document.getElementById('main-product-image');
  const mainImageLink = mainImage ? mainImage.parentElement : null;

  thumbnails.forEach(function(thumbnail) {
    thumbnail.addEventListener('click', function() {
      // Remove active class from all thumbnails
      thumbnails.forEach(t => t.classList.remove('active'));

      // Add active class to clicked thumbnail
      this.classList.add('active');

      // Update main image
      const newImageSrc = this.getAttribute('data-image');
      const newPopupSrc = this.getAttribute('data-popup');

      if (mainImage && newImageSrc) {
        mainImage.src = newImageSrc;
      }

      if (mainImageLink && newPopupSrc) {
        mainImageLink.href = newPopupSrc;
      }
    });
  });
});

// Subscription plan description toggle
$('#input-subscription').on('change', function(e) {
    var element = this;
    $('.subscription').addClass('d-none');
    $('#subscription-description-' + $(element).val()).removeClass('d-none');
});

// Add to cart form submission
$('#form-product').on('submit', function(e) {
    e.preventDefault();

    $.ajax({
        url: 'index.php?route=checkout/cart.add&language={{ language }}',
        type: 'post',
        data: $('#form-product').serialize(),
        dataType: 'json',
        contentType: 'application/x-www-form-urlencoded',
        cache: false,
        processData: false,
        beforeSend: function() {
            $('#button-cart').html('<span class="spinner-border spinner-border-sm me-2"></span>Adding...').prop('disabled', true);
        },
        complete: function() {
            $('#button-cart').html('<i class="bi bi-cart-plus"></i> {{ button_cart }}').prop('disabled', false);
        },
        success: function(json) {
            console.log(json);

            $('#form-product').find('.is-invalid').removeClass('is-invalid');
            $('#form-product').find('.invalid-feedback').removeClass('d-block');

            if (json['error']) {
                for (key in json['error']) {
                    $('#input-' + key.replaceAll('_', '-')).addClass('is-invalid').find('.form-control, .form-select, .form-check-input, .form-check-label').addClass('is-invalid');
                    $('#error-' + key.replaceAll('_', '-')).html(json['error'][key]).addClass('d-block');
                }
            }

            if (json['success']) {
                $('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="bi bi-check-circle-fill me-2"></i> ' + json['success'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
                $('#cart').load('index.php?route=common/cart.info&language={{ language }}');
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
});

// Initialize image magnifier (if magnificPopup is available)
$(document).ready(function() {
    if ($.fn.magnificPopup) {
        $('.image-magnifier').magnificPopup({
            type: 'image',
            delegate: 'a',
            gallery: {
                enabled: true
            }
        });
    }
});
</script>

{{ footer }}
